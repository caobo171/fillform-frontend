<section id="form" class="form">
    <div class="container"  style="text-align: center;" data-aos="fade-up">
{{#if msg}}
    <div class="alert alert-primary" role="alert">
    <p>{{msg}}</p>
    {{#ifEquals email formData.owner}}
    <a type="button" class="btn btn-primary" href="/form/run/{{formData.slug}}">T·∫°o y√™u c·∫ßu ƒëi·ªÅn ƒë∆°n ngay!</a>
    {{/ifEquals}}
    {{#ifEquals role "admin"}}
    <a type="button" class="btn btn-primary" href="/form/run/{{formData.slug}}">T·∫°o y√™u c·∫ßu ƒëi·ªÅn ƒë∆°n ngay!</a>
    {{/ifEquals}}
    </div>         
{{/if}}

        <div class="section-title">
            <h2>ƒêi·ªÅn theo t·ªâ l·ªá mong mu·ªën</h2>
            <div>
                <a type="button" class="mb-2 btn btn-primary" href="">ƒêi·ªÅn theo t·ªâ l·ªá mong mu·ªën</a>
                <a type="button" class="mb-2 btn btn-outline-primary" href="/form/prefill/{{formData.slug}}">ƒêi·ªÅn theo data c√≥ tr∆∞·ªõc</a>
            </div>
            <p>B·∫°n ƒëi·ªÅn <b>t·ªâ l·ªá mong mu·ªën (ƒë∆°n v·ªã %) l√† s·ªë t·ª± nhi√™n</b>, t∆∞∆°ng ·ª©ng v·ªõi m·ªói ƒë√°p √°n c·ªßa c√¢u h·ªèi nh√©</p>
            <p>N·∫øu b·∫°n ch∆∞a bi·∫øt ƒëi·ªÅn. H√£y th·ª≠ <a href="/form/autofill/{{formData.slug}}" style="color: #1458f7; font-size:18px"><b>·∫•n v√†o ƒë√¢y</b></a> ƒë·ªÉ fillform <b>ƒë·ªÅ xu·∫•t t·ªâ l·ªá</b> cho b·∫°n tham kh·∫£o nha!(T·ªâ l·ªá mang t√≠nh ch·∫•t tham kh·∫£o ƒë·ªÉ b·∫°n duy·ªát tr∆∞·ªõc).</p>
            <p><b>H√£y ch·ªânh s·ª≠a t·ªâ l·ªá ƒë·ªÉ ph√π h·ª£p nh·∫•t v·ªõi ƒë·ªÅ t√†i c·ªßa b·∫°n</b>FillForm s·∫Ω ch·ªâ cam k·∫øt ƒëi·ªÅn form ƒë√∫ng theo y√™u c·∫ßu t·ªâ l·ªá</p>
            <p>Video h∆∞·ªõng d·∫´n chi ti·∫øt: <a href="https://www.youtube.com/watch?v=3_r-atbIiAI" style="color: #1458f7">https://www.youtube.com/watch?v=3_r-atbIiAI</a> </p>
        </div>

            <form method="POST" action="./form">
                <div class="form-group">
                    <div class="input-group mb-3">
                        <span class="input-group-text" style="width:30%">Link Form</span>
                        <input type="text"   class="form-control" style="width:70%" id="urlMain" name="urlMain" value={{formData.urlMain}}>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text" style="width:30%">T√™n Form</span>
                        <input type="text"  class="form-control" style="width:70%" id="urlCopy" name="urlCopy" value="{{formData.name}}">
                    </div>
                    <input type="text" hidden readonly class="form-control" style="width:70%" id="lang" name="lang" value="{{config.lang}}">
                    <input type="text" hidden readonly class="form-control" style="width:70%" id="isValidCollectEmail" name="isValidCollectEmail" value="{{config.isValidCollectEmail}}">
                    <input type="text" hidden readonly class="form-control" style="width:70%" id="isValidEditAnswer" name="isValidEditAnswer" value="{{config.isValidEditAnswer}}">
                    <input type="text" hidden readonly class="form-control" style="width:70%" id="isValidLimitRes" name="isValidLimitRes" value="{{config.isValidLimitRes}}">
                    <input type="text" hidden readonly class="form-control" style="width:70%" id="isValidPublished" name="isValidPublished" value="{{config.isValidPublished}}">
                </div>
            </form>
        {{#if error}}
            <div class="alert alert-primary" role="alert">
            {{error}}
            </div>
        {{/if}}

        <form method="POST" action="/form/{{formData.slug}}" style="text-align: left;" id="myForm">
            <div class="form-group" style="background-color: rgba(208, 208, 208, 0.149)">
    {{#each formData.loaddata as |question questionid|}}
                <div class=" question" style="padding: 5px;" >
                    <div class="row gy-2 gx-3 align-items-center">
                        <div class="col-lg-4 order-1 align-items-center">
                        {{#if question.description}}
                            <label for="basic-url" class="formNoWrap" style="width: 38%;"><b>{{question.question}}</b></label>
                            <label for="basic-url" class=" formNoWrap" style="width: 60%;">{{question.description}}</label>
                        {{else}}
                            <label for="basic-url" class="formNoWrap" style="width: 98%;"><b>{{question.question}}</b></label>            
                        {{/if}}
                        </div>  
                        <div class="col-lg-8 order-2">
                            <div class="row gy-2 gx-3 align-items-center">
                            {{#if question.type}}
                                <input type="number" hidden readonly class="form-control formNoWrap" style="width:5%" name="isMulti-{{question.id}}" id="isMulti-{{question.id}}" value={{question.isMulti}}>
                                <input type="number" hidden readonly class="form-control formNoWrap" style="width:5%" name="totalans-{{question.id}}" id="totalans-{{question.id}}" value={{question.totalAnswer}}>
                                <input type="number" hidden readonly class="form-control formNoWrap" style="width:5%" name="type-{{question.id}}" id="type-{{question.id}}" value={{question.type}}>
                                {{#each question.answer as |answer answerid|}}
                                {{#if answer.data}}
                                <div class="multichoice-input">
                                    <div class="input-group">
                                        <div class="input-group-text formNoWrap" style="width:60%;">{{answer.data}}</div>
                                        <input type="number" min="0" step="1" class="form-control formNoWrap" style="width:40%" name={{answer.id}} id="{{answer.id}}" value={{answer.count}}>
                                    </div>
                                </div>
                                {{/if}}
                                {{/each}}
                            {{else}}
                                {{#each question.answer as |answer answerid|}}
                                <div class="col" style="width: 100%;">
                                    <div class="input-group">
                                        <div class="input-group-text formNoWrap" style="width:70%;">
                                            Ch·ªçn lo·∫°i c√¢u h·ªèi t·ª± lu·∫≠n (N·∫øu ch·ªçn "other-B·ªè qua kh√¥ng ƒëi·ªÅn" th√¨ b·∫°n ph·∫£i "t·∫Øt b·∫Øt bu·ªôc ƒëi·ªÅn tr√™n Google Form")
                                        </div>
                                        <select class="form-select answer-select" name="{{answer.id}}" id="select-{{answer.id}}" style="width:30%; font-size:13px">
                                            {{#each answer.options as |option optionid| }}
                                                {{#ifEquals option answer.count}}
                                                    <option selected value="{{answer.count}}">{{answer.count}}</option> 
                                                {{else}}
                                                    <option value="{{option}}">{{option}}</option> 
                                                {{/ifEquals}}
                                            {{/each}}
                                            {{!-- <option value="custom">Nh·∫≠p n·ªôi dung t√πy ch·ªânh</option>  --}}
                                        </select>
                                    </div>
                                    <textarea class="form-control mt-2 custom-input" id="custom-{{answer.id}}" name="custom-{{answer.id}}" 
                                    style="display: none; height: 100px; resize: vertical; white-space: pre-wrap; font-size:12px" 
                                    placeholder="Nh·∫≠p m·ªói d√≤ng 1 c√¢u tr·∫£ l·ªùi (·∫•n enter ƒë·ªÉ xu·ªëng d√≤ng). Kh√¥ng ƒë·ªÉ d√≤ng tr·ªëng. Tool s·∫Ω ƒëi·ªÅn l·∫∑p l·∫°i ng·∫´u nhi√™n n·∫øu s·ªë l∆∞·ª£ng kh√¥ng ƒë·ªß.">{{answer.data}}</textarea>
                                </div>    
                                {{/each}}
                            {{/if}}
                            </div>
                        </div>              
                    </div>
                </div>
    {{/each}}
            <button class="btn btn-primary mt-2" type="submit" style="width: 100%">L∆∞u l·∫°i v√† ti·∫øp t·ª•c</button>
            </div>
        </form>
    </div>

<div id="chat-container" style="text-align: left;">
<div id="chat-header" onclick="toggleChat()">
    <img src="/img/logo-white-short.png" alt="Logo" class="chat-logo">
    <span class="chat-title">B√© Fill ƒêi·ªÅn Form</span>
    <i id="chat-toggle-icon" class="bi bi-chat-dots">
        <span id="chat-badge"></span> <!-- Badge th√¥ng b√°o -->
    </i>
    <i id="chat-collapse-icon" class="bi bi-chevron-down">-</i> <!-- Icon thu g·ªçn -->
</div>

    <div id="chat-box">
        <div id="chat-messages" style="font-size: 13px;">
            <p>üí° Ch√†o b·∫°n! B√© Fill ·ªü ƒë√¢y ƒë·ªÉ gi√∫p b·∫°n check nh·ªØng r·ªßi ro Config nha.</p>
        </div>
    </div>
</div>


</section>
<script>
    document.getElementById('myForm').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            const target = event.target;
            if (target.tagName !== 'TEXTAREA' && target.type !== 'submit') {
                event.preventDefault(); 
            }
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".answer-select").forEach(select => {
            const inputId = select.id.replace("select-", "custom-");
            const inputField = document.getElementById(inputId);

            // Ki·ªÉm tra v√† hi·ªÉn th·ªã input ngay khi trang load
            if (select.value === "custom (n·ªôi dung t√πy ch·ªânh)") {
                inputField.style.display = "block";
            } else {
                inputField.style.display = "none";
            }

            // G√°n s·ª± ki·ªán change ƒë·ªÉ x·ª≠ l√Ω khi ng∆∞·ªùi d√πng thay ƒë·ªïi l·ª±a ch·ªçn
            select.addEventListener("change", function() {
                if (this.value === "custom (n·ªôi dung t√πy ch·ªânh)") {
                    inputField.style.display = "block";
                } else {
                    inputField.style.display = "none";
                }
            });
        });
    });
document.addEventListener("DOMContentLoaded", function () {
    const chatMessages = document.getElementById("chat-messages");
    const chatBadge = document.getElementById("chat-badge");

    function addChatError(message, errorId, type) {
        // Ki·ªÉm tra xem l·ªói ƒë√£ t·ªìn t·∫°i ch∆∞a
        if (document.getElementById(errorId)) return;

        // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o
        const errorElement = document.createElement("div");
        errorElement.className = "chat-error";
        errorElement.id = errorId;
        if(type == "error"){
            errorElement.innerHTML = `
                <div class="alert alert-danger" role="alert" style="font-size:12px;padding:5px">
                    <span class="button close-error" onclick="removeChatError('${errorId}')">‚úñ</span>
                    <strong>L·ªói!</strong> ${message}
                </div>
            `;
        }else if(type == "warning"){
            errorElement.innerHTML = `
                <div class="alert alert-warning" role="alert" style="font-size:12px;padding:5px">
                    <span class="button close-error" onclick="removeChatError('${errorId}')">‚úñ</span>
                    <strong>C·∫©n th·∫≠n!</strong> ${message}
                </div>
            `;
        }else if(type == "note"){
            errorElement.innerHTML = `
                <div class="alert alert-primary" role="alert" style="font-size:12px;padding:5px">
                    <span class="button close-error" onclick="removeChatError('${errorId}')">‚úñ</span>
                    <strong></strong> ${message}
                </div>
            `;
        }
        
        chatMessages.appendChild(errorElement);
        chatBadge.style.display = "inline-block"; // Hi·ªán badge n·∫øu c√≥ l·ªói
    }

    function removeChatError(errorId) {
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
            errorElement.remove();
        }
        updateChatBadge();
    }

    function updateChatBadge() {
        const errors = document.querySelectorAll(".chat-error");
        if (errors.length === 0) {
            chatBadge.style.display = "none"; // ·∫®n badge n·∫øu kh√¥ng c√≤n l·ªói
        }
    }

    function validateInputs() {
        document.querySelectorAll("input[type='number']").forEach(input => {
            const value = parseInt(input.value, 10);
            const errorId = `error-${input.id}`;

            // L·ªói 1: Kh√¥ng ph·∫£i s·ªë t·ª± nhi√™n t·ª´ 0-100
            if (value < 0 || value > 100) {
                addChatError(`Gi√° tr·ªã kh√¥ng h·ª£p l·ªá (${value}). H√£y ƒëi·ªÅn t·ªâ l·ªá (%) l√† s·ªë t·ª± nhi√™n t·ª´ 0-100`, errorId, "error");
            } else {
                removeChatError(errorId);
            }
        });

        // L·ªói 2: N·∫øu c√¢u h·ªèi l√† Multi (c·ªông c√°c input kh√¥ng qu√° 120)
        document.querySelectorAll("[id^='isMulti-']").forEach(multiInput => {
            const questionId = multiInput.id.split('-')[1];
            const totalInput = document.getElementById(`totalans-${questionId}`);
            const totalAnswer = totalInput ? parseInt(totalInput.value, 10) : 0;
            //const isMulti = document.getElementById(`isMulti-${questionId}`);
            let sum = 0;
            if(multiInput.value=="1"){ // C√¢u h·ªèi ch·ªçn nhi·ªÅu ƒë√°p √°n
                document.querySelectorAll(`input[id^='answer_${questionId}']`).forEach(input => {
                    sum += parseInt(input.value, 10) || 0;
                });

                if (sum < 120) {
                    addChatError(`C√¢u ch·ªçn nhi·ªÅu ƒë√°p √°n. C·∫ßn ƒëi·ªÅn t·ªâ l·ªá (%) l√† s·ªë t·ª± nhi√™n t·ª´ 0-100. V√† t·ªïng t·ªâ l·ªá n√™n l·ªõn h∆°n 120, ƒë·ªÉ tr·ªôn t·ªët nh·∫•t (hi·ªán t·∫°i: ${sum})`, `multi-error-${questionId}`, "error");
                } else {
                    removeChatError(`multi-error-${questionId}`);
                }
                            
            }
        });

        // L·ªói 3: N·∫øu ch·ªçn "other - b·ªè qua kh√¥ng ƒëi·ªÅn"
        document.querySelectorAll(".answer-select").forEach(select => {
            if (select.value.toLowerCase().includes("other")) {
                addChatError(`B·∫°n ch·ªçn "other - b·ªè qua kh√¥ng ƒëi·ªÅn". H√£y ki·ªÉm tra l·∫°i ƒë√£ t·∫Øt b·∫Øt bu·ªôc ƒëi·ªÅn tr√™n Google Form ch∆∞a?`, `select-error-${select.id}`, "warning");
            } else {
                removeChatError(`select-error-${select.id}`);
            }
        });
    }
    function validateConfig() {
        const lang = document.getElementById(`lang`);
        const isValidCollectEmail = document.getElementById(`isValidCollectEmail`);
        const isValidEditAnswer = document.getElementById(`isValidEditAnswer`);
        const isValidLimitRes = document.getElementById(`isValidLimitRes`);
        const isValidPublished = document.getElementById(`isValidPublished`);
        if(lang.value == "null"){
            addChatError(`Hi·ªán t·∫°i h·ªá th·ªëng kh√¥ng th·ªÉ ki·ªÉm tra config, h√£y nh·ªõ t·∫Øt thu th·∫≠p email v√† t·∫Øt gi·ªõi h·∫°n tr·∫£ l·ªùi nh√©`, `00000`, "warning");
        }
        else{
            if(isValidPublished.value == "false"){
                addChatError(`<b>Google Form!</b> Form ch∆∞a Xu·∫•t b·∫£n/Publish. N·∫øu l√† Form c≈© (tr∆∞·ªõc 2025) c√≥ th·ªÉ b·ªè qua l·ªói n√†y.`, `00004`, "error");
            }else if(isValidPublished.value == "null"){
                addChatError(`<b>Google Form!</b> Hi·ªán t·∫°i h·ªá th·ªëng kh√¥ng th·ªÉ ki·ªÉm tra config, h√£y nh·ªõ Xu·∫•t b·∫£n/Publish Form nh√©!`, `00004`, "warning");
            }
            if(isValidCollectEmail.value == "false"){
                addChatError(`<b>Google Form!</b> Ph·∫£i ch·ªçn "Kh√¥ng thu th·∫≠p email/ Do not Collect" trong setting.`, `00001`, "error");
            }else if(isValidCollectEmail.value == "null"){
                addChatError(`Hi·ªán t·∫°i h·ªá th·ªëng kh√¥ng th·ªÉ ki·ªÉm tra config, h√£y nh·ªõ t·∫Øt thu th·∫≠p email. Ph·∫£i ch·ªçn "Kh√¥ng thu th·∫≠p email/ Do not Collect" trong setting nh√©!`, `00001`, "warning");
            }

            if(isValidEditAnswer.value == "false"){
                addChatError(`<b>Google Form!</b> Ph·∫£i t·∫Øt cho ph√©p ch·ªânh s·ª≠a c√¢u tr·∫£ l·ªùi trong setting.`, `00002`, "error");
            }else if(isValidEditAnswer.value == "null"){
                addChatError(`<b>Google Form!</b> Hi·ªán t·∫°i h·ªá th·ªëng kh√¥ng th·ªÉ ki·ªÉm tra config, h√£y nh·ªõ t·∫Øt "cho ph√©p ch·ªânh s·ª≠a c√¢u tr·∫£ l·ªùi" trong setting nh√©!`, `00001`, "warning");
            }

            if(isValidLimitRes.value == "false"){
                addChatError(`<b>Google Form!</b> Ph·∫£i t·∫Øt m·ªçi gi·ªõi h·∫°n tr·∫£ l·ªùi trong setting.`, `00003`, "error");
            }else if(isValidLimitRes.value == "null"){
                addChatError(`<b>Google Form!</b> Hi·ªán t·∫°i h·ªá th·ªëng kh√¥ng th·ªÉ ki·ªÉm tra config, h√£y nh·ªõ t·∫Øt m·ªçi gi·ªõi h·∫°n tr·∫£ l·ªùi trong setting nh√©!`, `00001`, "warning");
            }
            if(isValidCollectEmail.value == "true" && isValidEditAnswer.value == "true" && isValidLimitRes.value == "true" && isValidPublished.value == "true"){
                addChatError(`Tuy·ªát! Google form n√†y setting OK. H√£y config t·ªâ l·ªá nh√©.`, `00005`, "note");
            }
        }

    }

    // L·∫Øng nghe thay ƒë·ªïi tr√™n input ƒë·ªÉ ki·ªÉm tra l·ªói
    document.querySelectorAll("input[type='number']").forEach(input => {
        input.addEventListener("input", validateInputs);
    });

    document.querySelectorAll(".answer-select").forEach(select => {
        select.addEventListener("change", validateInputs);
    });
    validateConfig();
    validateInputs(); // Ki·ªÉm tra l·ªói ngay khi load trang
    document.getElementById('chat-container').classList.add('open');

});

function toggleChat() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.classList.toggle('open');

    // ƒê·ªïi icon thu g·ªçn/m·ªü r·ªông
    const collapseIcon = document.getElementById('chat-collapse-icon');
    collapseIcon.classList.toggle('bi-chevron-down');
    collapseIcon.classList.toggle('bi-chevron-up');
    const collapseIconDisplay = document.getElementById("chat-collapse-icon");
    collapseIconDisplay.textContent ="";
}

function removeChatError(errorId) {
    document.getElementById(errorId)?.remove();
    updateChatBadge();
}

function updateChatBadge() {
    const errors = document.querySelectorAll(".chat-error");
    document.getElementById("chat-badge").style.display = errors.length ? "inline-block" : "none";
}



</script>